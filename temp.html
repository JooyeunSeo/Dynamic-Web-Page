{% extends 'base.html' %}
{% block title %}
  {% if current_user.is_authenticated %}
    To-do List of {{ current_user.name }}
  {% else %}
    Make your own to-do list
  {% endif %}
{% endblock %}

{% block content %}
<!-- 드롭박스 스타일 변경 -->
<style>
  select {
    all: unset;
    appearance: auto;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px 10px 6px;
    font-size: 1rem;
    width: auto;
    color: black;
  }

  .important-icon.active {
    color: gold;
    content: "★";
}
</style>

<script>
  const checkbox = document.getElementById("is_important");
  const toggle = document.getElementById("important-toggle");

  toggle.addEventListener("click", function () {
    toggle.classList.toggle("active");
    toggle.innerText = toggle.classList.contains("active") ? "★" : "☆";
    checkbox.checked = toggle.classList.contains("active");
  });

  if (checkbox.checked) {
    toggle.classList.add("active");
    toggle.innerText = "★";
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>


<div id="main">
  <div class="inner">
    <!-- 제목 -->
    {% if current_user.is_authenticated %}
	  <h1>To-do List of {{ current_user.name }}</h1>
    {% else %}
      <h1>Log in to use the service!</h1>
    {% endif %}

    <!-- task 추가 -->
    {% if current_user.is_authenticated %}
      <h2>➕ Add new task</h2>

        <form method="POST" class="row g-3">
            {{ form.hidden_tag() }}
            <!-- 할 일 입력 -->
            <div class="col-md-6">
                {{ form.text(class="form-control", rows="2") }}
            </div>
            <!-- 중요도 선택 -->
            <div class="col-md-2">
                {{ form.is_important }}
                <span id="important-toggle" class="important-icon" style="cursor:pointer; font-size: 1.5rem;">☆</span>
            </div>
            <!-- 기한 설정 -->
            <div class="col-md-3">
                {{ form.due_date(class="form-control form-control-sm", style="border-radius: 5px; padding: 1px;", placeholder="YYYY-MM-DD HH:MM") }}
            </div>
            <!-- 제출 버튼 -->
            <div class="col-md-1">
                {{ form.submit(class="button small") }}
            </div>
        </form>

    {% else %}
      <a href="{{ url_for('login') }}">로그인하러 가기</a>
    {% endif %}


    <!-- 진행 중인 task 리스트 -->
    {% if current_user.is_authenticated %}
        {% if pending_tasks %}
            <form method="POST" action="{{ url_for('todo_list_home') }}">
                {{ form.hidden_tag() }}  <!-- CSRF token 추가 -->

                <div id="task-list">
                  {% for task in pending_tasks %}
                    <div class="task-item d-flex align-items-center" data-id="{{ task.id }}">
                      <span class="handle me-2" style="cursor: move;">☰</span>
                      <!-- 체크박스 -->
                      {{ form.is_done() }}{{ form.is_done.label }}
                      <p>{{ task.text }} - 마감: {{ task.due_date }}</p>
                    </div>
                  {% endfor %}
                </div>

                <button type="submit" class="btn btn-primary">Update Tasks</button>
            </form>
         {% else %}
             <p>할 일이 없습니다.</p>
         {% endif %}
    {% else %}
        <p>로그인하면 나만의 할 일 목록을 확인하고 관리할 수 있어요.</p>
    {% endif %}


    <!-- 완료한 task 리스트 -->
    <h3>✅ 완료한 작업</h3>
    {% if current_user.is_authenticated %}
        {% if completed_tasks %}
            <ul>
                {% for task in completed_tasks %}
                    <li style="text-decoration: line-through;">{{ task.text }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>아직 완료한 일이 없어요.</p>
        {% endif %}
    {% else %}
        <p>로그인하면 나만의 할 일 목록을 확인하고 관리할 수 있어요.</p>
    {% endif %}


    <!-- task 리스트 -->
    <h3>🗑️ 기한이 지난 작업</h3>
    {% if current_user.is_authenticated %}
        {% if overdue_tasks %}
            <ul>
                {% for task in overdue_tasks %}
                    <li style="color: red;">{{ task.text }} - 마감: {{ task.due_date }} (기한 초과)</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>지각한 작업은 없습니다. 다행이네요!</p>
       {% endif %}
    {% else %}
        <p>로그인하면 나만의 할 일 목록을 확인하고 관리할 수 있어요.</p>
    {% endif %}


  </div>
</div>
{% endblock %}