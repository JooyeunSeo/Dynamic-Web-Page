{% extends 'base.html' %}
{% block title %}Write or Vanish{% endblock %}

{% block content %}
<div id="main">
  <div class="inner">
	<h1 style="margin-bottom: 1%;">
      <span>Write</span>
      <span style="color: gray;">or</span>
      <span style="color: red;">Vanish</span>
    </h1>
    <p>If you stop for more than <b>5 seconds</b>, everything will disappear.</p>

    <!-- ê¸€ì“°ê¸° ì‹œê°„ ì„¤ì • ë¶€ë¶„ -->
    <div class="input-row" style="margin-bottom: 20px;">
      <form method="post" style="width: 100%; display: flex; align-items: center; gap: 10px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <label for="writing_time" style="white-space: nowrap; margin: 0;">Writing Time</label>

        <select id="writing_time" style="width: auto; min-width: 60px; height: 34px;">
          <option value="10">10 seconds</option>
          <option value="60">1 minute</option>
          <option value="180">3 minutes</option>
          <option value="300">5 minutes</option>
          <option value="600">10 minutes</option>
          <option value="900">15 minutes</option>
          <option value="1800">30 minutes</option>
        </select>

        <button type="button" class="button primary" id="startBtn" style="margin-top: 5px; height: 34px; line-height: 34px;">Start</button>
      </form>
    </div>

    <!-- ì‹œê°„ ì§„í–‰ í‘œì‹œ ë°” : í•­ìƒ í‘œì‹œ, ê¸°ë³¸ì€ íë¦¬ê²Œ -->
    <div id="timeBarContainer">
      <div id="timeBar"></div>
    </div>

    <!-- ê¸€ì“°ê¸° ì˜ì—­ : í•­ìƒ í‘œì‹œí•˜ë˜ ê¸°ë³¸ì€ ì½ê¸° ì „ìš© -->
    <div id="writingArea" contenteditable="false"></div>

    <!-- ê²°ê³¼ ë²„íŠ¼ -->
    <div id="afterWritingOptions" style="display: none; margin-top: 10px;">
      <p>â˜ºï¸ You saved your text!</p>
      <button id="copyBtn" class="button icon solid" style="margin-right: 15px;"><i class="fas fa-copy"></i> Copy</button>
      <button id="shareBtn" class="button icon solid"><i class="fas fa-share-alt"></i> Share</button>
    </div>

    <!-- ì¬ì‹œë„ ì•ˆë‚´ (ì…ë ¥ ì¤‘ë‹¨ ì‹œì—ë§Œ) -->
    <div id="retryPrompt" style="display: none; margin-top: 10px; color: #ff0000">
      <p>ğŸ˜± Your text has been completely deleted!</p>
    </div>

  </div>
</div>


<style>
#timeBarContainer {
  width:100%;
  height:10px;
  border-radius:10px;
  background:#c2c2c2;
  margin-bottom:10px;
  overflow:hidden;
  opacity:.4;
}

#timeBarContainer.active {
  background: #ffe5ec; /* ì—°í•œ í•‘í¬ìƒ‰ (í™œì„±í™” ì‹œ) */
  opacity: 1;
}

#timeBar {
  height:100%;
  width:0%;
  background:#ef7993;
}

#writingArea {
  width: 100%;
  height: 200px;
  border: 2px solid #4e4e4e;
  border-radius: 5px; /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
  padding: 10px;
  font-size: 1.5rem;
  overflow: auto;
  box-sizing: border-box;
}

#writingArea::-webkit-scrollbar {
  width: 8px;
  border-radius: 10px;
}

#writingArea::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 10px;
}

#writingArea::-webkit-scrollbar-thumb {
  background-color: rgba(239,121,147,0.3);
  border-radius: 10px;
}

#writingArea:focus {
  outline: none;
  border-color: #ef7993;
  box-shadow: 0 0 5px #ef7993;
}

@keyframes shake {      /* ì§„ë™ ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
  0%, 100% { transform: translate(0px, 0px); }
  25% { transform: translate(2px, 0); }
  50% { transform: translate(0, 2px); }
  75% { transform: translate(-2px, 0); }
}

.shake {              /* ì§„ë™ íš¨ê³¼ í´ë˜ìŠ¤ */
  animation: shake 0.5s infinite;
}
</style>

<script>
// ===== DOM =====
const startBtn           = document.getElementById("startBtn");
const writingArea        = document.getElementById("writingArea");
const afterWritingOpts   = document.getElementById("afterWritingOptions");
const retryPrompt        = document.getElementById("retryPrompt");
const writingTimeSelect  = document.getElementById("writing_time");
const timeBarContainer   = document.getElementById("timeBarContainer");
const timeBar            = document.getElementById("timeBar");

// ===== ìƒíƒœ ë³€ìˆ˜ =====
let sessionTimer   = null;   // ì „ì²´ ê¸€ì“°ê¸° íƒ€ì´ë¨¸
let idleTimer      = null;   // 1ì´ˆ ì§€ì—° í›„ ê²½ê³  íƒ€ì´ë¨¸
let warnInterval   = null;   // 1ì´ˆë§ˆë‹¤ ìƒ‰/ì§„ë™
let redIntensity   = 0;
let started        = false;
let elapsed        = 0;
let duration       = 0;

// ===== ì‹œì‘ ë²„íŠ¼ =====
startBtn.onclick = () => {
  // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„¤ì •ëœ ê¸€ì“°ê¸° ì‹œê°„(ì´ˆ)ì„ ê°€ì ¸ì˜´
  duration = parseInt(writingTimeSelect.value);
  if (!duration) { alert("Set the writing time."); return; }

  // UI ì´ˆê¸°í™”: ì´ì „ ê²°ê³¼ ìˆ¨ê¹€, ê¸€ì“°ê¸° ì˜ì—­ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤ ì„¤ì •
  writingArea.innerHTML  = "";
  writingArea.contentEditable = "true";
  writingArea.focus();
  writingArea.style.color = "#000";
  writingArea.style.background = "#fff";
  timeBar.style.width     = "100%";
  timeBarContainer.style.opacity = "1";     // íƒ€ì„ ë°” í™œì„±í™” ì‹œ ë¶ˆíˆ¬ëª…í•˜ê²Œ ë³€ê²½
  timeBarContainer.classList.add("active"); // íƒ€ì„ ë°” í™œì„±í™” ì‹œ ë°°ê²½ìƒ‰ í•‘í¬ìƒ‰ìœ¼ë¡œ ë³€ê²½
  afterWritingOpts.style.display = "none";
  retryPrompt.style.display      = "none";

  // ë“œë¡­ë‹¤ìš´ê³¼ ë²„íŠ¼ ë¹„í™œì„±í™” â†’ ì„¸ì…˜ ë„ì¤‘ ë³€ê²½ ë°©ì§€
  writingTimeSelect.disabled = true;
  startBtn.disabled          = true;
  started = true;  elapsed = 0;

  // --- ë©”ì¸ íƒ€ì´ë¨¸(1ì´ˆ ê°„ê²©ìœ¼ë¡œ ê²½ê³¼ ì‹œê°„ ê³„ì‚° ë° íƒ€ì„ë°” ì—…ë°ì´íŠ¸) ---
  sessionTimer = setInterval(() => {
    // ê²½ê³¼ ì‹œê°„ 1ì´ˆ ì¦ê°€
    elapsed++;

    // ë‚¨ì€ ì‹œê°„ì„ ë¹„ìœ¨ë¡œ ê³„ì‚° (0%ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì¢…ë£Œ ì§ì „)
    const pct = ((duration - elapsed) / duration) * 100;
    timeBar.style.width = pct + "%";

    // ì •í•´ì§„ ì‹œê°„ì´ ëë‚˜ë©´ ì„±ê³µìœ¼ë¡œ ì„¸ì…˜ ì¢…ë£Œ
    if (elapsed >= duration) endSession(true);
  }, 1000);

  writingArea.oninput = resetIdleTimer;
  resetIdleTimer();            // ì²« ì…ë ¥ ê°ì‹œ ì‹œì‘
};

// ===== ì…ë ¥ ì¤‘ë‹¨ ê°ì‹œ =====
function resetIdleTimer() {
  // ì´ì „ì˜ ì…ë ¥ ì¤‘ë‹¨ ê°ì§€ íƒ€ì´ë¨¸ ë° ê²½ê³  íƒ€ì´ë¨¸ ì œê±°
  clearTimeout(idleTimer);
  clearInterval(warnInterval);

  // ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
  redIntensity = 0;
  writingArea.style.background = "#fff";
  writingArea.classList.remove("shake");

  // 1ì´ˆ ë™ì•ˆ ì…ë ¥ì´ ì—†ìœ¼ë©´ startWarning() ì‹¤í–‰
  idleTimer = setTimeout(startWarning, 1000);
}

function startWarning() {
  let idleSec = 0;  // ì…ë ¥ì´ ë©ˆì¶˜ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)

  warnInterval = setInterval(() => {
    if (!started) return;

    / ë°°ê²½ìƒ‰ì´ ì ì  ë¶‰ì–´ì§€ë©° ê²½ê³  ê°•í™”
    redIntensity = Math.min(redIntensity + 40, 255);
    writingArea.style.background = `rgba(255,100,100,${(redIntensity/255).toFixed(2)})`;

    writingArea.classList.add("shake");                  // í”ë“¤ë¦¼ íš¨ê³¼ ì¶”ê°€ (CSS ì• ë‹ˆë©”ì´ì…˜)
    if (navigator.vibrate) navigator.vibrate(150);       // ëª¨ë°”ì¼ ì§„ë™ ê¸°ëŠ¥ (ì§€ì› ë¸Œë¼ìš°ì €ì— í•œí•¨)

    // 5ì´ˆ ì´ìƒ ì…ë ¥ì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼í•˜ê³  ì„¸ì…˜ ì¢…ë£Œ
    if (++idleSec >= 5) {
      endSession(false);
    }
  }, 1000);   // ë§¤ 1ì´ˆë§ˆë‹¤ ê²½ê³  ìƒíƒœ ê°•í™”
}

// ===== ì„¸ì…˜ ì¢…ë£Œ ì²˜ë¦¬ =====
function endSession(success) {
  started = false;

  // íƒ€ì´ë¨¸Â·ê²½ê³  ëª¨ë‘ ì •ë¦¬
  clearInterval(sessionTimer);
  clearTimeout(idleTimer);
  clearInterval(warnInterval);

  // ì‹œê° íš¨ê³¼ ì›ìƒ ë³µê·€
  writingArea.classList.remove("shake");
  writingArea.style.background = "#fff";
  timeBar.style.width = "0%";
  timeBarContainer.style.opacity = ".4";          // íƒ€ì„ ë°” ë¹„í™œì„±í™” ì‹œ íˆ¬ëª…í•˜ê²Œ
  timeBarContainer.classList.remove("active");    // íƒ€ì„ ë°” ë¹„í™œì„±í™” ì‹œ ë‹¤ì‹œ íšŒìƒ‰ìœ¼ë¡œ ì´ˆê¸°í™”

  // í¸ì§‘ ì ê¸ˆ
  writingArea.contentEditable = "false";

  // ë²„íŠ¼ ì¬í™œì„±
  writingTimeSelect.disabled = false;
  startBtn.disabled          = false;

  if (success) {                 // ì •ìƒ ì¢…ë£Œ
    afterWritingOpts.style.display = "block";
    retryPrompt.style.display      = "none";
  } else {                       // ì…ë ¥ ì¤‘ë‹¨ ì‹¤íŒ¨
    writingArea.innerHTML = "";
    afterWritingOpts.style.display = "none";
    retryPrompt.style.display      = "block";
  }
}

// ===== ë³µì‚¬ / ê³µìœ  ë²„íŠ¼ =====
document.getElementById("copyBtn").onclick  = () =>
  navigator.clipboard.writeText(writingArea.innerText)
    .then(() => alert("Your text has been copied."))
    .catch(() => alert("Failed to copy"));

document.getElementById("shareBtn").onclick = () => {
  const text = writingArea.innerText;
  navigator.share ? navigator.share({ text }) :
  alert("This browser does not support the sharing.");
};
</script>

{% endblock %}