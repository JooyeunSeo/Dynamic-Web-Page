{% extends 'base.html' %}
{% block title %}Smart Exchange Calculator{% endblock %}

{% block content %}
<div class="container">

  <h1 class="title" style="margin-bottom: 20px;">ForEx Time Machine</h1>
  <p style="margin-bottom: 5px; font-size: 1rem;">
    Explore how exchange rates have changed between a past date and today.
  </p>
  <ul style="font-size: 1rem;">
    <li>Access exchange rate data from one year ago up to the present.</li>
    <li>See how your selected past date compares to today in conversion results.</li>
    <li>Visualize the 1 year trend with your chosen period highlighted on the graph.</li>
  </ul>
  <p style="font-size: 1rem;">
    âš ï¸ Please note that this service uses the free API from <a href="https://exchangerate.host/">exchangerate.host</a>, which allows a maximum of 100 requests per month. If the service does not respond, I appreciate your understanding.
  </p>
  <hr>

  <form method="POST" class="form-box">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <!-- === í†µí™” ì„ íƒ === -->
    <div class="row">
      <div class="col">
        <label>Your Currency</label>
        <select name="from_currency" required>
          {% for code, cur in currencies.items() %}
            <option value="{{ code }}" {% if from_currency == code %}selected{% endif %}>
              {{ cur.flag }} {{ code }} - {{ cur.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label>Target Currency</label>
        <select name="to_currency" required>
          {% for code, cur in currencies.items() %}
            <option value="{{ code }}" {% if to_currency == code %}selected{% endif %}>
              {{ cur.flag }} {{ code }} - {{ cur.name }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- === ê¸ˆì•¡ ì…ë ¥ === -->
    <div class="row">
      <div class="col">
        <label style="margin-top: 7px; margin-bottom: 5px;">Amount</label>
        <input type="text" id="amount-input" name="amount" value="{{ amount if amount else '' }}" required>
      </div>
    </div>

    <!-- === ë‚ ì§œ ì„ íƒ === -->
    <div class="row">
      <div class="col">
        <label>Past Date</label>
        <input type="date" name="a_date" value="{{ a_date }}" min="{{ year_ago }}" max="{{ today }}" required>
      </div>

      <div class="col">
        <label>Recent Date</label>
        <input type="date" name="b_date" value="{{ b_date }}" min="{{ year_ago }}" max="{{ today }}" required>
      </div>
    </div>

    <!-- === Flash ë©”ì‹œì§€ í‘œì‹œ === -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages" style="text-align:center; margin:10px 0;">
          {% for category, message in messages %}
            <span class="flash {{ category }}">{{ message }}</span>
            <br>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <button class="button primary" type="submit" style="width: 100%; margin-top: 10px;">Exchange & Compare</button>
  </form>

  <!-- === ê²°ê³¼ í‘œì‹œ === -->
  {% if a_amount and b_amount %}
  <div class="result-box">
    <div class="result-row">
      <div class="result-col">
        <h2>{{ a_date }}</h2>
        <p><b>{{ "{:,.2f}".format(a_amount|float) }}</b> {{ to_currency }}</p>
      </div>

      <div class="result-col">
        <h2>{{ b_date }}</h2>
        <p><b>{{ "{:,.2f}".format(b_amount|float) }}</b> {{ to_currency }}</p>
      </div>
    </div>

    <!-- ë³€í™”ìœ¨ -->
    <div class="change-box">
      {% if percent_change %}
        {% if percent_change > 0 %}
          <p class="change up">â–² {{ percent_change|round(2) }}% (Increase)</p>
        {% elif percent_change < 0 %}
          <p class="change down">â–¼ {{ percent_change|round(2) }}% (Decrease)</p>
        {% else %}
          <p class="change neutral">â€” 0% (No Change)</p>
        {% endif %}
      {% else %}
        <p class="change neutral">â€” N/A</p>
      {% endif %}
    </div>

  </div>
  {% endif %}
</div>

<!-- === ğŸ“ˆê·¸ë˜í”„ ì¶œë ¥ === -->
{% if fx_graph %}
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>    <!-- Plotly JS -->
  <div class="graph-container">
    {{ fx_graph|safe }}
  </div>
{% endif %}

<!-- === ğŸŒˆ JS/CSS === -->
<!--<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> &lt;!&ndash; Select2 JS &ndash;&gt;-->

{% block page_scripts %}
  <script>
  $(function() {
      $('select').select2();
  });
  </script>

  <script>
  /*
    ê¸ˆì•¡ ì…ë ¥ í•„ë“œ(amount-input) ìë™ í¬ë§· ìŠ¤í¬ë¦½íŠ¸
    - ìˆ«ìì™€ ì†Œìˆ˜ì ë§Œ í—ˆìš©
    - ì •ìˆ˜ ë¶€ë¶„ì€ 3ìë¦¬ë§ˆë‹¤ ',' ì¶”ê°€
    - ì¤‘ë³µ ì„ ì–¸ ë°©ì§€ (í…œí”Œë¦¿ì´ ì—¬ëŸ¬ ë²ˆ ë Œë”ë§ ë˜ì–´ë„ ì˜¤ë¥˜ ë°©ì§€)
  */

  if (!window.amountInput) {  // ì´ë¯¸ ì„ ì–¸ëœ amountInputê°€ ì—†ìœ¼ë©´ ì‹¤í–‰
      const amountInput = document.getElementById('amount-input');  // ì…ë ¥ í•„ë“œ ì„ íƒ
      window.amountInput = amountInput;  // ì „ì—­(window)ì— ì €ì¥í•˜ì—¬ ì¤‘ë³µ ì„ ì–¸ ë°©ì§€

      // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      amountInput.addEventListener('input', (e) => {
          let value = e.target.value;

          // ìˆ«ìì™€ ì†Œìˆ˜ì (.)ë§Œ í—ˆìš©, ë‚˜ë¨¸ì§€ ë¬¸ì ì œê±°
          value = value.replace(/[^0-9.]/g, '');

          // ì†Œìˆ˜ì ì´ ì—¬ëŸ¬ ê°œ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ë§Œ ë‚¨ê¸°ê³  ì œê±°
          const parts = value.split('.');
          if (parts.length > 2) {
              value = parts[0] + '.' + parts.slice(1).join('');
          }

          // ì •ìˆ˜ì™€ ì†Œìˆ˜ ë¶„ë¦¬
          let [integerPart, decimalPart] = value.split('.');

          // ì •ìˆ˜ ë¶€ë¶„ 3ìë¦¬ë§ˆë‹¤ ',' ì¶”ê°€
          if (integerPart) {
              integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          }

          // ë‹¤ì‹œ í•©ì³ì„œ ì…ë ¥ í•„ë“œ ê°’ ê°±ì‹ 
          e.target.value = decimalPart !== undefined ? `${integerPart}.${decimalPart}` : integerPart;
      });
  }
  </script>

  <style>
    .container { max-width: 800px; margin: auto; padding: 20px; }
    .row { display: flex; gap: 5px; margin-bottom: 10px; }
    .col { flex: 1; display: flex; flex-direction: column; }
    .graph-container { margin: 10 auto; max-width: 100%; padding: 0 20px; box-sizing: border-box; }
    .result-box { margin-top: 15px; padding: 30px; border: 1px solid #e5e5e5; border-radius: 10px; font-size: 1.1rem; }
    .result-row { display: flex; justify-content: space-between; }
    .result-col { text-align: center; width: 45%; }
    .change-box { text-align: center; margin-top: 15px; font-weight: bold; font-size: 1.2rem; }
    .change-box p { margin: 0; line-height: 1.2; }
    .change.up { color: #d9534f; }
    .change.down { color: #0275d8; }
    .change.neutral { color: #666; }
    .button.primary:hover { background-color: #4e8ff6; cursor: pointer; }
    .flash.error { color: red; font-size: 0.9rem; font-weight: bold; }
    .select2-container { width: 100% !important; }
    .select2-container .select2-selection--single { height: 44px; border-radius: 8px; display: flex; align-items: center; }
    input[type="text"]:focus { border-bottom-color: #aaaaaa; box-shadow: inset 0 -1px 0 0 #4e8ff6; }    /* í´ë¦­/í¬ì»¤ìŠ¤ ì‹œ */
    input[type="date"] {
      appearance: none;           /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
      -webkit-appearance: none;
      -moz-appearance: none;
      border: 1px solid #aaaaaa;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 1rem;
      background-color: #fff;
    }
    input[type="date"]:focus { outline: none; border-color: #4e8ff6; }
    @media(max-width: 600px) {
      .result-row {
        flex-direction: row;      /* ê°€ë¡œ ìœ ì§€ */
        gap: 10px;
        flex-wrap: wrap;          /* í•„ìš”í•˜ë©´ ì¤„ë°”ê¿ˆ */
      }
      .result-col {
        flex: 1 1 45%;            /* ìµœì†Œ 45% ë„ˆë¹„, í™”ë©´ì— ë§ì¶° ì¡°ì • */
        text-align: center;
      }
    }

  </style>
{% endblock %}

{% endblock %}