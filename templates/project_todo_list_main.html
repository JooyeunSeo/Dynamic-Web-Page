{% extends 'base.html' %}
{% block title %}
  {% if current_user.is_authenticated %}
    {{ current_user.name }}'s to-do list
  {% else %}
    Make your own to-do list!
  {% endif %}
{% endblock %}

{% block content %}
<div id="main">
  <div class="inner">
    <!-- ì œëª© -->
    {% if current_user.is_authenticated %}
	  <h1>{{ current_user.name }}'s to-do list</h1>
<!--      <p>í˜„ì¬ ì‹œê°„ëŒ€: {{ session.get('timezone') }}</p>-->
    {% else %}
      <h1>Make your own to-do list!</h1>
    {% endif %}

    <!------------------------- task ì¶”ê°€ ------------------------->
    {% if current_user.is_authenticated %}
      <h2>
        Todo: {{ pending_tasks|length }} &nbsp;|&nbsp;
        Completed: {{ completed_tasks|length }} &nbsp;|&nbsp;
        Overdue: {{ overdue_tasks|length }}
      </h2>

        <form method="POST" class="row g-3">
            {{ form.hidden_tag() }}
            <!-- í•  ì¼ ì…ë ¥ -->
            <div class="col-md-6">
                {{ form.text(class="form-control", rows="2") }}
            </div>
            <!-- ê¸°í•œ ì„¤ì • -->
            <div class="col-md-3">
                {{ form.due_date(class="form-control form-control-sm", style="border-radius: 5px; padding: 1px;", placeholder="YYYY-MM-DD HH:MM") }}
            </div>
            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="col-md-1">
                {{ form.submit(class="button small") }}
            </div>
        </form>
    {% else %}
      <p>
        Go to <b><a href="{{ url_for('login') }}">Log in</a></b> or
        <b><a href="{{ url_for('register') }}">make account</a></b> to use the service.
        <br><br>
      </p>
    {% endif %}

    <!----------------------- ì§„í–‰ ì¤‘ì¸ task ë¦¬ìŠ¤íŠ¸ ----------------------->
    {% if current_user.is_authenticated %}
        {% if pending_tasks %}
            <div id="task-list">
              {% for task in pending_tasks %}
                <div class="task-item d-flex align-items-center mb-2" data-id="{{ task.id }}" data-done="false" data-overdue="false">
                  <!-- ë©”ë‰´ë²„íŠ¼ -->
                  <span class="handle me-2" style="cursor: move;">â˜°</span>

                  <!-- ì²´í¬ì•„ì´ì½˜ -->
                  <span role="button" onclick="toggleIsDone({{ task.id }})" style="cursor: pointer; font-size: 1.2rem; margin-right: 0.5rem;" title="change statement">
                    {% if task.is_done %}â–£
                    {% else %}â–¡
                    {% endif %}
                  </span>

                  <!-- í…ìŠ¤íŠ¸ + ë§ˆê°ì¼ -->
                  <div style="flex: 1 1 auto; min-width: 0;">
                    <!-- í…ìŠ¤íŠ¸ (í´ë¦­ ì‹œ ìˆ˜ì • ê°€ëŠ¥) -->
                    <span class="task-text" onclick="editTaskText({{ task.id }})" id="task-text-{{ task.id }}" style="overflow-wrap: break-word; margin-right: 0.9rem;">
                    {{ task.text }}
                    </span>

                    <!-- ìˆ¨ê²¨ì§„ í¼(í…ìŠ¤íŠ¸ ìˆ˜ì •) -->
                    <form method="POST"
                          action="{{ url_for('todo_list_update_text', task_id=task.id) }}"
                          class="edit-text-form d-inline"
                          id="edit-form-{{ task.id }}"
                          style="display: none;"
                          onsubmit="return true;">
                    {{ form.csrf_token }}
                    <input type="text"
                           name="text"
                           value="{{ task.text }}"
                           class="form-control form-control-sm d-inline"
                           style="width: auto; max-width: 300px;"
                           onblur="this.form.submit()">
                    </form>

                    <!-- ë§ˆê°ì¼ -->
                    <span class="due-date-display" onclick="editDueDate({{ task.id }})">
                      <code class="text-muted ms-2" style="font-size: 0.8rem; vertical-align: middle;">
                        {% if task.due_date %}
                          {{ task.due_date.strftime('%Y-%m-%d(%a), %H:%M') }}
                        {% else %}
                          No Due Date
                        {% endif %}
                      </code>
                    </span>

                    <!-- ìˆ¨ê²¨ì§„ í¼ (ìˆ˜ì •ìš© datetime picker) -->
                    <form method="POST"
                          action="{{ url_for('todo_list_update_due_date', task_id=task.id) }}"
                          class="d-inline due-date-form"
                          style="display: none;"
                          onsubmit="return true;">
                      {{ form.csrf_token }}
                     <input type="datetime-local"
                           name="due_date"
                           value="{{ task.due_date.strftime('%Y-%m-%dT%H:%M') if task.due_date else '' }}"
                           class="form-control form-control-sm d-inline align-middle"
                           style="width: 200px; height: 1.5em; line-height: 2.0em; font-size: 1.0rem; padding: 0 4px; vertical-align: middle;"
                           onchange="this.form.submit()">
                    </form>
                  </div>

                  <!-- ì‚­ì œ ì•„ì´ì½˜ -->
                  <span role="button" class="ms-2 text-danger" onclick="deleteTask({{ task.id }})" style="cursor: pointer; ">âœ˜</span>
                </div>
              {% endfor %}
            </div>
         {% endif %}
    {% endif %}


    <!---------------------------- ì™„ë£Œí•œ task ë¦¬ìŠ¤íŠ¸ ---------------------------->
    {% if current_user.is_authenticated %}
        {% if completed_tasks %}
            <div class="completed-task-list">
              {% for task in completed_tasks %}
                <div class="task-item d-flex align-items-center justify-content-between mb-2" data-id="{{ task.id }}" data-done="true" data-overdue="false">

                  <!-- ì™¼ìª½: ì²´í¬ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ -->
                  <div class="d-flex align-items-center flex-wrap" style="flex: 1 1 auto; min-width: 0;">
                    <span role="button" onclick="toggleIsDone({{ task.id }})"
                          style="cursor: pointer; font-size: 1.2rem; margin-left: 1.6rem; margin-right: 0.5rem; color: #999;"
                          title="change statement">
                      {% if task.is_done %}â–£
                      {% else %}â–¡
                      {% endif %}
                    </span>

                    <span class="ms-2 text-truncate" style="margin-right: 0.5rem; color: #999; max-width: 100%;">
                      <del>{{ task.text }}</del>
                    </span>
                  </div>

                  <!-- ì˜¤ë¥¸ìª½: ì‚­ì œ ì•„ì´ì½˜ -->
                  <span role="button" class="ms-2 text-danger" onclick="deleteTask({{ task.id }})"
                        style="cursor: pointer; color: #999;">âœ˜</span>
                </div>
              {% endfor %}
            </div>
        {% endif %}
    {% endif %}

    <!--------------------------- ê¸°í•œ ì§€ë‚œ task ë¦¬ìŠ¤íŠ¸ --------------------------->
    {% if current_user.is_authenticated %}
        {% if overdue_tasks %}
            <div class="overdue-task-list">
              {% for task in overdue_tasks %}
                <div class="task-item d-flex align-items-center justify-content-between mb-2" data-id="{{ task.id }}" data-done="false" data-overdue="true">

                  <!-- ì™¼ìª½: ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ -->
                  <div class="d-flex align-items-center flex-wrap" style="flex: 1 1 auto; min-width: 0;">
                    <!-- ì•„ì´ì½˜ (disabled) -->
                    <span style="cursor: not-allowed; font-size: 1.2rem; margin-left: 1.5rem; margin-right: 0.5rem;" title="statement fix">ğŸš¨</span>

                    <!-- ë‚´ìš© ë° ë§ˆê°ì¼ -->
                    <span class="ms-2 text-danger text-truncate" style="margin-right: 0.5rem; color: #f00; max-width: 100%;">
                      {{ task.text }} [Due by {{ task.due_date.strftime('%Y-%m-%d(%a), %H:%M') }}]
                    </span>
                  </div>

                  <!-- ì˜¤ë¥¸ìª½: ì‚­ì œ ì•„ì´ì½˜ -->
                  <span role="button" class="ms-2 text-danger" onclick="deleteTask({{ task.id }})"
                        style="cursor: pointer; color: #f00;">âœ˜ï¸</span>
                </div>
              {% endfor %}
            </div>
       {% endif %}
    {% endif %}
  </div>
</div>

<style>
.task-item {
  display: flex;
  align-items: center;
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: #fdfdfd;
}

.handle {
  cursor: move;
  margin-right: 10px;
  font-size: 18px;
}

.form-check-input {
  margin-right: 10px;
  margin-top: 0;
  cursor: pointer;
}

.task-item span {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

code {
  background-color: #f1f1f1;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 0.85rem;
}

input[type="datetime-local"] {
  border: 2px solid #4e4e4e;
  border-radius: 5px;
  padding: 1px;
  color: #333;
  cursor: pointer;
}

input[type="datetime-local"]:focus {
  border-color: #ef7993;
  outline: none; /* íŒŒë€ í…Œë‘ë¦¬ ì œê±° */
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>  <!-- SortableJS -->
<script>
new Sortable(document.getElementById('task-list'), {
  handle: '.handle',            // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì˜ì—­ (ì•„ì´ì½˜ ë“±)
  animation: 150,               // ë“œë˜ê·¸ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ì†ë„ (ms)
  onEnd: function (evt) {       // ìˆœì„œ ë³€ê²½ í›„ í•¨ìˆ˜ ì‹¤í–‰
    const order = [...document.querySelectorAll('#task-list .task-item')].map(item => item.dataset.id);
    fetch("{{ url_for('todo_list_reorder_tasks') }}", {          // ìˆœì„œëŒ€ë¡œ id ìˆ˜ì§‘
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify(order)              // ìƒˆ ìˆœì„œ ì„œë²„ë¡œ ì „ì†¡
    });
  }
});
</script>
<script>
function editDueDate(taskId) {
  const display = document.querySelector(`[onclick="editDueDate(${taskId})"]`);
  const form = display.nextElementSibling;
  display.style.display = 'none';
  form.style.display = 'inline';
}
</script>
<script>
function editTaskText(taskId) {
  const textSpan = document.getElementById(`task-text-${taskId}`);
  const form = document.getElementById(`edit-form-${taskId}`);
  textSpan.style.display = 'none';
  form.style.display = 'inline';
  const input = form.querySelector('input');
  input.focus();
  input.setSelectionRange(input.value.length, input.value.length);
}
</script>
<script>
function toggleIsDone(taskId) {
  fetch(`/todo_list/toggle_done/${taskId}`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
    }
  }).then(() => location.reload());
}
</script>
<script>
function deleteTask(taskId) {
  if (!confirm("Do you really want to delete this task?")) return;

  fetch(`/todo_list/delete/${taskId}`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",  // CSRF ë³´í˜¸ìš© í† í°
    }
  }).then(response => {
    if (response.ok) {
      // DOMì—ì„œ ì‚­ì œ
      const taskItem = document.querySelector(`[data-id="${taskId}"]`);
      if (taskItem) {
        taskItem.remove();
        updateTaskCounts();  // task í•­ëª©ë³„ ìˆ«ì ê°±ì‹  í•¨ìˆ˜ ì‹¤í–‰
      }
    } else {
      alert("failed to delete!");
    }
  });
}
</script>
<script>
function updateTaskCounts() {
  const allTasks = document.querySelectorAll(".task-item");
  let pending = 0, completed = 0, overdue = 0;

  allTasks.forEach(task => {
    const done = task.dataset.done === "true";
    const overdueFlag = task.dataset.overdue === "true";

    if (done) completed++;
    else if (overdueFlag) overdue++;
    else pending++;
  });

  const h2 = document.querySelector("h2");
  h2.innerHTML = `Todo: ${pending} &nbsp;|&nbsp; Completed: ${completed} &nbsp;|&nbsp; Overdue: ${overdue}`;
}
</script>

{% endblock %}